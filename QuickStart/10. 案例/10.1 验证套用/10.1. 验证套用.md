# ğŸš€ CryptoVerifier

---

## éªŒè¯å¥—ç”¨

è¯¥ç¯‡æ¡ˆä¾‹è®²è§£å°†ä¼šå¯¹ä¸€ä¸ªæ™®é€šçš„ Hello world Java ç¨‹åºå¥—ç”¨éªŒè¯ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å…¶å®ç°å¤§å·®ä¸å·®ã€‚

---

## Maven ä¾èµ–

`CryptoVerifier` çš„éªŒè¯ç«¯ä½¿ç”¨äº†è¿™äº›ä¾èµ–:

- [Lombok](https://projectlombok.org/setup/maven) - ç®€åŒ–ä»£ç 
- [Apache commons io](https://mvnrepository.com/artifact/commons-io/commons-io) - ç®€åŒ– IO æµç¨‹
- [oshi](https://github.com/oshi/oshi) - è·å–ç¡¬ä»¶è¯†åˆ«ç  (HWID)

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ‚¨å¼•å…¥ `CryptoVerifier-Commons` ä¾èµ–ï¼Œå…³äºæ­¤ä¾èµ–ä¿¡æ¯å¯ä»¥åœ¨ `æ’ä»¶å¼€å‘å…¥é—¨` æ‰¾åˆ°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`CryptoVerifier-Commons` ä½œä¸ºæœ¬åœ° Jar ä¾èµ–ï¼Œæ‚¨éœ€è¦å°†å…¶æ‰“åŒ…è¿›æ‚¨çš„é¡¹ç›®ä¸­ï¼Œæ‚¨å¯ä»¥é‡å®šä½å®ƒï¼Œä½†æ˜¯æ··æ·†å¿…é¡»æ’é™¤:

- `twomillions.other.cryptoverifier.enums.communication`
- `twomillions.other.cryptoverifier.data.communication`

ä¸‹çš„æ‰€æœ‰ç±»ï¼Œè¿™äº›ç±»ç”±äºåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„éœ€è¦ï¼Œæ‚¨ç»ä¸èƒ½æ··æ·†å®ƒä»¬ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ Maven è¿›è¡Œæ¼”ç¤ºï¼ŒGradle 

åœ¨ Maven é…ç½®ä¸­ï¼Œæˆ‘æƒ³ä»¬éœ€è¦ç”¨åˆ°ä¸€äº›æ’ä»¶æ¥å®Œæˆæœ¬åœ° Jar æ‰“åŒ…ï¼Œè®©æˆ‘ä»¬å…ˆå¼•å…¥ä¾èµ–:

```xml
<dependencies>
    <!-- https://projectlombok.org/setup/maven -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.26</version>
        <scope>provided</scope>
    </dependency>

    <!-- https://mvnrepository.com/artifact/com.google.code.gson/gson -->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.10.1</version>
        <scope>compile</scope>
    </dependency>

    <!-- https://mvnrepository.com/artifact/commons-io/commons-io -->
    <dependency>
        <groupId>commons-io</groupId>
        <artifactId>commons-io</artifactId>
        <version>2.13.0</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/com.github.oshi/oshi-core -->
    <dependency>
        <groupId>com.github.oshi</groupId>
        <artifactId>oshi-core</artifactId>
        <version>6.4.3</version>
    </dependency>

    <!-- CryptoVerifier-Commons åº“ï¼Œç”¨äºç½‘ç»œè¯·æ±‚ä¸åŠ å¯†è§£å¯† -->
    <dependency>
        <groupId>twomillions.other.cryptoverifier</groupId>
        <artifactId>CryptoVerifier-Commons</artifactId>
        <version>1.0.0</version>
        <scope>system</scope>
        <!-- CryptoVerifier-Commons åº“ Jar çš„è·¯å¾„ -->
        <systemPath>${project.basedir}/../../../../CryptoVerifier-Commons/target/CryptoVerifier-Commons-1.0.0.jar</systemPath>
    </dependency>
</dependencies>
```

è¿™äº›ä¾èµ–ç‰ˆæœ¬å·å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ï¼Œå¦‚æœ‰éœ€è¦ï¼Œæ‚¨éœ€è¦è‡ªè¡Œæ›´æ”¹ç‰ˆæœ¬å·ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦é…ç½®æ’ä»¶:

```xml
<build>
    <plugins>
        <!-- ä½¿ç”¨ Maven Shade æ’ä»¶ï¼Œåœ¨æ‰“åŒ…æ—¶åˆå¹¶ä¾èµ– -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-shade-plugin</artifactId>
            <version>3.4.1</version>
            <executions>
                <execution>
                    <phase>package</phase>
                    <goals>
                        <goal>shade</goal>
                    </goals>
                    <configuration>
                        <!-- ä¸ç”Ÿæˆç²¾ç®€çš„ä¾èµ– POM æ–‡ä»¶ -->
                        <createDependencyReducedPom>false</createDependencyReducedPom>
                        <!-- é‡å®šå‘ä¾èµ– -->
                        <relocations>
                            <relocation>
                                <pattern>twomillions.other.cryptoverifier</pattern>
                                <shadedPattern>org.example.cryptoverifier</shadedPattern>
                            </relocation>
                        </relocations>
                    </configuration>
                </execution>
            </executions>
        </plugin>

        <!-- ä½¿ç”¨ Maven Dependency æ’ä»¶ï¼Œä¸ºäº†å°†æœ¬åœ°ä¾èµ–æ‰“åŒ…è¿›æœ€ç»ˆ Jar -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-dependency-plugin</artifactId>
            <version>3.3.0</version>
            <executions>
                <execution>
                    <id>unpack-dependencies</id>
                    <phase>prepare-package</phase>
                    <goals>
                        <goal>unpack-dependencies</goal>
                    </goals>
                    <configuration>
                        <!-- ä»…è§£å‹ç³»ç»ŸèŒƒå›´ä¾èµ– -->
                        <includeScope>system</includeScope>
                        <!-- ä»…è§£å‹ GroupId ä¸º twomillions.other.cryptoverifier çš„ä¾èµ–  -->
                        <includeGroupIds>twomillions.other.cryptoverifier</includeGroupIds>
                        <!-- è§£å‹åå­˜æ”¾åˆ°æ„å»ºè·¯å¾„ä¸‹çš„ classes æ–‡ä»¶å¤¹å†…ï¼Œæ‰“åŒ…ä¾èµ–è¿›æœ€ç»ˆ Jar  -->
                        <outputDirectory>${project.build.directory}/classes</outputDirectory>
                    </configuration>
                </execution>
            </executions>
        </plugin>

        <!-- ä½¿ç”¨ Maven Jar æ’ä»¶ï¼Œé…ç½®ç”Ÿæˆå¯æ‰§è¡Œ Jar æ–‡ä»¶çš„æ¸…å• -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <version>3.3.0</version>
            <configuration>
                <archive>
                    <manifest>
                        <!-- æŒ‡å®šä¸»ç±» -->
                        <mainClass>org.example.Main</mainClass>
                    </manifest>
                </archive>
            </configuration>
        </plugin>
    </plugins>
</build>
```

æˆ‘ä»¬ä½¿ç”¨ `Maven Shade` æ’ä»¶ä»¥æ”¯æŒé‡å®šå‘æ“ä½œï¼Œå¹¶ä½¿ç”¨ `Maven Dependency` æ’ä»¶å°† `groupId` å…ƒç´ ä¸º `twomillions.other.cryptoverifier` çš„ä¾èµ–è§£å‹è‡³æ„å»ºè·¯å¾„ä¸‹çš„ `classes` æ–‡ä»¶å¤¹ç”¨äºæ‰“åŒ…ã€‚
æœ€åä½¿ç”¨ `Maven Jar` æ’ä»¶é…ç½®å¯æ‰§è¡Œ Jar æ–‡ä»¶çš„æ¸…å•ï¼Œå¹¶æŒ‡å®šä¸»ç±»ã€‚


---

## éªŒè¯å®ç°

ç›®å‰æˆ‘ä»¬å·²ç»é…ç½®å¥½äº† Mavenï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°† `ExampleClient` ä¸­çš„æ‰€æœ‰ç±»å¤åˆ¶åˆ°é¡¹ç›®ä¸­ã€‚

è¿™é‡Œæˆ‘å°† `Client` ç±»é‡å‘½åä¸º `Main`ï¼Œæ‚¨éœ€è¦æ‰“å¼€è¿™ä¸ªç±»ï¼Œå¹¶åœ¨å…¥å£æ–¹æ³•æ·»åŠ éªŒè¯æœåŠ¡å™¨çš„ IP:

```java
    /**
     * ä¸»ç¨‹åºå…¥å£æ–¹æ³•ã€‚
     *
     * @param args å‘½ä»¤è¡Œå‚æ•°
     */
    public static void main(String[] args) {
        ips.add("127.0.0.1:17354");

        startVerifyThread();
    }
```

é¡ºä¾¿æ›´æ”¹æˆå‘˜å˜é‡ `filePath` ä¸ `fileName`ï¼Œå°†å…¶æ”¹ä¸ºéœ€è¦è¿›è¡ŒéªŒè¯çš„è®¸å¯è¯æ–‡ä»¶è·¯å¾„ä¸æ–‡ä»¶å:

```java
    /**
     * éªŒè¯æ–‡ä»¶çš„è·¯å¾„ã€‚
     */
    private static final String filePath = "D:/JavaProjects/CryptoVerifier/clientFiles";

    /**
     * éªŒè¯æ–‡ä»¶çš„æ–‡ä»¶åã€‚
     */
    private static final String fileName = "test";
```

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ›´æ”¹ `Verifier` ç±»ï¼Œæ·»åŠ æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ä¸å¯¹éªŒè¯å¤±è´¥çš„å¤„ç†:

ä¸ºäº†çµæ´»æ€§ï¼Œæˆ‘ä»¬å¸Œæœ›éªŒè¯å¤±è´¥ä¸‰æ¬¡å†åœæ­¢ä¸šåŠ¡ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæˆå‘˜å˜é‡:

```java
    /**
     * å¤±è´¥æ¬¡æ•°ã€‚
     */
    private int failed = 0;
```

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ›´æ”¹ `verify` æ–¹æ³•ï¼Œä¸ºå…¶æ·»åŠ å¤±è´¥å¤„ç†çš„éƒ¨åˆ†:

```java
    /**
     * è¿›è¡Œä¸€æ¬¡éªŒè¯ã€‚
     */
    public void verify() {
        String lowestIp = LatencyMeasurement.findLowestLatencyServer(ips);

        if (lowestIp == null) {
            System.out.println("æ‰€æœ‰çš„éªŒè¯æœåŠ¡å™¨å‡æ— æ³•è¿æ¥, åœæ­¢éªŒè¯!");
            System.exit(0);
            return;
        }

        /*
         * å½“é‡åˆ°éªŒè¯å¤±è´¥åˆ™å¤±è´¥æ¬¡æ•°å¢åŠ ä¸€æ¬¡ (++ åœ¨å‰ä¸ºå…ˆå¢åŠ å†ä½¿ç”¨, åœ¨åä¸ºä½¿ç”¨åå¢åŠ )
         * æˆåŠŸéªŒè¯ç›´æ¥ returnï¼Œå‡ºç°å¼‚å¸¸åˆ™æ•è·æç¤ºåç»§ç»­è¿è¡Œä¸‹é¢ä»£ç ï¼Œåˆ¤æ–­å¤±è´¥æ¬¡æ•°è¶…è¿‡ä¸‰æ¬¡ç›´æ¥é€€å‡º
         */
        try {
            String[] splitIp = lowestIp.split(":");
            communicate(splitIp[0], Integer.parseInt(splitIp[1]), credentialData);
            return;
        } catch (UnknownHostException exception) {
            System.out.println("æ— ç½‘ç»œ! ç´¯è®¡éªŒè¯: " + (++ failed) + "/3");
        } catch (SocketException exception) {
            System.out.println("æ— æ³•è¿æ¥è‡³éªŒè¯æœåŠ¡å™¨! è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€! ç´¯è®¡éªŒè¯: " + (++ failed) + "/3");
        } catch (Exception exception) {
            System.out.println("éªŒè¯æ—¶å‡ºé”™, è®¸å¯è¯æ˜¯å¦æ­£ç¡®? ç´¯è®¡éªŒè¯: " + (++ failed) + "/3");
        }

        if (failed >= 3) {
            System.out.println("ç´¯è®¡éªŒè¯å¤±è´¥ä¸‰æ¬¡, é€€å‡ºç¨‹åº!");
            System.exit(0);
        }
    }
```

ç°åœ¨å·²ç»å®Œæˆäº†ä¸‰æ¬¡çš„å®¹é”™ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ `handleResult` æ–¹æ³•ä¸­æ·»åŠ æˆ‘ä»¬çš„ä¸šåŠ¡å¤„ç†éƒ¨åˆ†:

```java
    /**
     * å¯¹è¿”å›å†…å®¹è¿›è¡Œå¤„ç†ã€‚
     *
     * <p>
     * æ‚¨éœ€è¦åœ¨è¿™é‡Œå¤„ç†éªŒè¯é€»è¾‘ï¼Œåˆ¤æ–­æœåŠ¡å™¨è¿”å›çš„æ•°æ®ç­‰ç­‰ã€‚
     * </p>
     *
     * @param result éªŒè¯æœåŠ¡å™¨è¿”å›çš„å†…å®¹ (å·²è§£å¯†)
     */
    private void handleResult(String result) {
        if (result.equalsIgnoreCase("error")) {
            System.out.println("éªŒè¯é”™è¯¯, æœåŠ¡å™¨å‘é€æ•°æ®ä¸æ­£ç¡®? è¯·åé¦ˆç»™å¼€å‘è€…!");
            System.exit(0);
            return;
        }

        String resultToLowerCase = result.toLowerCase();

        if (!resultToLowerCase.contains("success")) {
            System.out.println("è®¸å¯è¯éªŒè¯å¤±è´¥! è¯·åé¦ˆç»™å¼€å‘è€…!");
            System.exit(0);
            return;
        }

        /*
         * è¿™é‡Œçš„ loaded å˜é‡æ—¨åœ¨å¤šæ¬¡éªŒè¯æ—¶ç¡®ä¿åªåœ¨ç¬¬ä¸€æ¬¡å¤„ç†ä¸šåŠ¡é€»è¾‘ (åŠ è½½æ’ä»¶ã€åŠ è½½ç±»ç­‰ç­‰)
         */
        if (!loaded) {
            loaded = true;

            String[] resultSplit = result.split("\\|");

            String uuid = resultSplit[1];
            String expirationDate = resultSplit[2].equals("0") ? "æ°¸ä¸è¿‡æœŸ" : TimeUtils.convertLongToDateString(Long.parseLong(resultSplit[2]));
            String verificationInfo = resultSplit[3];

            System.out.println("éªŒè¯é€šè¿‡! ç”¨æˆ·: " + uuid + ", è¿‡æœŸæ—¶é—´: " + expirationDate + ", éªŒè¯ä¿¡æ¯: " + verificationInfo);

            // è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œå‡è®¾æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘åªæ˜¯è¾“å‡º Hello world!
            System.out.println("Hello world!");
        }
    }
```

æˆ‘ä»¬ä¸å»ºè®®æ‚¨åˆ›å»ºä¸€ä¸ªæ–¹æ³•æˆ–è€…ç±»æ¥å•ç‹¬å¤„ç†è¿™äº›é€»è¾‘ï¼Œå…·ä½“è¯·çœ‹ `æ›´åŠ å®‰å…¨`ã€‚

ç°åœ¨æˆ‘ä»¬è¿˜éœ€è¦å¯¹ä¸€äº›å¯èƒ½å­˜åœ¨çš„é—®é¢˜è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚æœåŠ¡å™¨æœªå“åº”æˆ–å‘é€çš„å†…å®¹æ— æ³•æˆåŠŸè½¬æ¢ç­‰:

```java
    /**
     * æœåŠ¡å™¨æ— å“åº”æ—¶çš„å¤„ç†ã€‚
     *
     * <p>
     * è‹¥éªŒè¯æœåŠ¡å™¨ä¸å­˜åœ¨é—®é¢˜ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯é»‘å®¢åœ¨å°è¯•é€šè¿‡æœ¬åœ°æ­å»ºè™šå‡æœåŠ¡å™¨æ¥ç ´è§£éªŒè¯ï¼Œæ‚¨éœ€è¦å¤„ç†è¿™ç§æƒ…å†µã€‚
     * </p>
     *
     * <p>
     * é‡åˆ°è¿™ç§æƒ…å†µé€šå¸¸æ„å‘³ç€æ— æ³•ä¸æ­£ç¡®çš„éªŒè¯æœåŠ¡å™¨å–å¾—è¿æ¥ï¼Œæˆ‘ä»¬å»ºè®®åˆ é™¤æ‚¨çš„ Jar ä¸è®¸å¯è¯æ–‡ä»¶æ¥ç»™é»‘å®¢é€ æˆä¸€äº›éº»çƒ¦ï¼Œæˆ–ç›´æ¥é€€å‡ºç¨‹åºã€‚
     * </p>
     */
    private void handleServerUnresponsive() {
        // ç›´æ¥é€€å‡ºç¨‹åº
        System.exit(0);
    }

    /**
     * æœåŠ¡å™¨å‘é€çš„å†…å®¹æ— æ³•è¢«è½¬æ¢æˆ {@link RequestData} å¯¹è±¡æ—¶çš„å¤„ç†ã€‚
     *
     * <p>
     * è‹¥éªŒè¯æœåŠ¡å™¨ä¸å­˜åœ¨é—®é¢˜ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯é»‘å®¢åœ¨å°è¯•é€šè¿‡æœ¬åœ°æ­å»ºè™šå‡æœåŠ¡å™¨æ¥ç ´è§£éªŒè¯ï¼Œæ‚¨éœ€è¦å¤„ç†è¿™ç§æƒ…å†µã€‚
     * </p>
     *
     * <p>
     * é‡åˆ°è¿™ç§æƒ…å†µé€šå¸¸æ„å‘³ç€æ— æ³•ä¸æ­£ç¡®çš„éªŒè¯æœåŠ¡å™¨å–å¾—è¿æ¥ï¼Œæˆ‘ä»¬å»ºè®®åˆ é™¤æ‚¨çš„ Jar ä¸è®¸å¯è¯æ–‡ä»¶æ¥ç»™é»‘å®¢é€ æˆä¸€äº›éº»çƒ¦ï¼Œæˆ–ç›´æ¥é€€å‡ºç¨‹åºã€‚
     * </p>
     */
    private void handleRequestDataError() {
        // ç›´æ¥é€€å‡ºç¨‹åº
        System.exit(0);
    }
```

è‡³æ­¤ï¼Œä¾¿å·²ç»å®Œæˆäº†å¯¹äºç¨‹åºçš„éªŒè¯å¥—ç”¨ï¼Œ`Bukkit` æ’ä»¶äº¦æˆ–è€…å…¶ä»–æ¨¡ç»„ä¹Ÿå·®ä¸å¤šï¼Œä¸è¿‡å…¥å£ä¸åŒã€‚

æµ‹è¯•è¾“å‡º:

```
éªŒè¯é€šè¿‡! ç”¨æˆ·: test, è¿‡æœŸæ—¶é—´: æ°¸ä¸è¿‡æœŸ, éªŒè¯ä¿¡æ¯: test111.
Hello world!
```

æ‚¨å¯èƒ½ä¼šçœ‹è§æ§åˆ¶å°æœ‰è¿™ç§å­—æ ·:

```
SLF4J: No SLF4J providers were found.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See https://www.slf4j.org/codes.html#noProviders for further details.
```

è¯·ç§»æ­¥æ­¤å¤„: https://github.com/oshi/oshi/issues/2402

---

## è‡ªè¡Œç¼–å†™ç¡¬ä»¶ç ç”Ÿæˆ

è¿™æ˜¯å¯è¡Œçš„ï¼Œæ‚¨åªéœ€è¦ä¿®æ”¹ `Main` ä¸­ `verify` æ–¹æ³•å†… `CredentialData` å¯¹è±¡çš„æ„é€ å‚æ•°å³å¯ã€‚

```java
    /**
     * å¿«é€ŸéªŒè¯æ–¹æ³•ã€‚
     *
     * @param verifier {@link Verifier} å¯¹è±¡
     * @param extraData é¢å¤–æ•°æ®
     * @throws Exception è·å–éªŒè¯å†…å®¹æˆ–éªŒè¯æ—¶å‘ç”Ÿå¼‚å¸¸
     */
    private static void verify(Verifier verifier, @SuppressWarnings("SameParameterValue") String extraData) throws Exception {
        File file = new File(filePath, fileName);
        String fileString = FileUtils.readFileToString(file, "UTF-8");
        String hwid = ???;

        CredentialData credentialData = new CredentialData(
                fileString, fileName, hwid, extraData
        );

        verifier.setIps(ips);
        verifier.setCredentialData(credentialData);

        verifier.verify();
    }
```

---